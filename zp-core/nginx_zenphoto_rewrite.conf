# Note: this file is for users of NGINX only! 
# If you don't know if you're using nginx or not, you aren't. Consult the htaccess documentation instead.
#
# INSTRUCTIONS for configuring URL rewriting for NGINX servers
#
# 1. Copy this file to your nginx configuration directory (usually /etc/nginx)
# 2. Make a copy of this template file and name it with the subdirectory you wish to 
#    install Zenphoto under: eg "zenphoto-photos.conf"
# 2. In a text editor, find-and-replace-all $zproot$ with the subdirectory Zenphoto is 
#    installed in, with a forward slash (eg: "/photos" without the quotes)
#    - If NOT installing zenphoto in a subdirectory, remove all occurrences of $zproot$ 
#      (find-and-replace-all with blank)
# 4. In your nginx server block, set up your server as normal for a PHP application.
#    Follow the recommendation here: http://wiki.nginx.org/ZenPhoto (but skip everything 
#    after and including the "location @zenphoto" line as that's included below)
# 5. At the end of your server configuration block, add the line:
#        include zenphoto-demo.conf;
#    where "zenphoto-demo.conf" is the name of the file you created from the template.
#
#    You may include several subdirectories, or include zenphoto at the root and in
#    subdirectories by creating the configuration files from the template and including 
#    them in this manner.

location @zenphoto {
    # experimental rss rules
    rewrite index\.php\?^rss-(.*)&(.*)                  $zproot$/index.php?rss=$1 last;
    rewrite index\.php\?^rss-(.*)$                      $zproot$/index.php?rss=$1 last;

    rewrite index\.php$                                 $zproot$/index.php last;
    rewrite ^$zproot$/(.*)/page/([A-Za-z0-9_\-]+)/?$     $zproot$/index.php?album=$1&page=$2 last;

    # Images and stuff
    rewrite "^$zproot$/(.*)/image/(thumb|[0-9]{1,4})/([^$zproot$/\\\]+)$"  $zproot$/zp-core/i.php?a=$1&i=$3&s=$2  last;
    rewrite ^$zproot$/(.*)/image/([^$zproot$/\\\]+)$                       $zproot$/zp-core/i.php?a=$1&i=$2  last;
    rewrite "^$zproot$/(.*)/album/(thumb|[0-9]{1,4})/([^$zproot$/\\\]+)$"  $zproot$/zp-core/i.php?a=$1&i=$3&s=$2&album=true  last;

    # Catch all for unknown stuff
    rewrite ^$zproot$/(.*)/?$ $zproot$/index.php?album=$1 last;
}

location @albums {
    rewrite ^$zproot$/albums/?(.+/?)?$  $zproot$/$1  redirect;
}

location $zproot$/albums {
    try_files $uri @albums;
}

# Admin pages
location $zproot$/admin {
    rewrite ^$zproot$/admin/?$  $zproot$/zp-core/admin.php  redirect;
}

# Tiny URLs
location $zproot$/tiny {
    rewrite ^$zproot$/tiny/([0-9]+)/?$ $zproot$/index.php?p=$1&t last;
}

# Page
location $zproot$/page {
    rewrite ^$zproot$/page/([0-9]+)/?$                   $zproot$/index.php?page=$1 last;
    rewrite ^$zproot$/page/([A-Za-z0-9\-_]+)/?$          $zproot$/index.php?p=$1 last;
    rewrite ^$zproot$/page/([A-Za-z0-9_\-]+)/([0-9]+)/?$ $zproot$/index.php?p=$1&page=$2 last;
}

# Pages
location $zproot$/pages {
    rewrite ^$zproot$/pages/?$           $zproot$/index.php?p=pages last;
    rewrite ^$zproot$/pages/(.*)/?$      $zproot$/index.php?p=pages&title=$1 last;
}

# Search
location $zproot$/page/search {
    rewrite ^$zproot$/page/search/fields([0-9]+)/(.*)/([0-9]+)/?$    $zproot$/index.php?p=search&searchfields=$1&words=$2&page=$3 last;
    rewrite ^$zproot$/page/search/fields([0-9]+)/(.*)/?$             $zproot$/index.php?p=search&searchfields=$1&words=$2 last;
    rewrite ^$zproot$/page/search/archive/(.*)/([0-9]+)/?$           $zproot$/index.php?p=search&date=$1&page=$2 last;
    rewrite ^$zproot$/page/search/archive/(.*)/?$                    $zproot$/index.php?p=search&date=$1 last;
    rewrite ^$zproot$/page/search/tags/(.*)/([0-9]+)/?$              $zproot$/index.php?p=search&searchfields=tags&words=$1&page=$2 last;
    rewrite ^$zproot$/page/search/tags/(.*)/?$                       $zproot$/index.php?p=search&searchfields=tags&words=$1 last;
    rewrite ^$zproot$/page/search/(.*)/([0-9]+)/?$                   $zproot$/index.php?p=search&words=$1&page=$2 last;
    rewrite ^$zproot$/page/search/(.*)/?$                            $zproot$/index.php?p=search&words=$1 last;
}

# News
location $zproot$/news {
    rewrite ^$zproot$/news/?$                            $zproot$/index.php?p=news last;
    rewrite ^$zproot$/news/([0-9]+)/?$                   $zproot$/index.php?p=news&page=$1 last;
    rewrite ^$zproot$/news/category/(.*)/([0-9]+)/?$     $zproot$/index.php?p=news&category=$1&page=$2 last;
    rewrite ^$zproot$/news/category/(.*)/?$              $zproot$/index.php?p=news&category=$1 last;
    rewrite ^$zproot$/news/archive/(.*)/([0-9]+)/?$      $zproot$/index.php?p=news&date=$1&page=$2 last;
    rewrite ^$zproot$/news/archive/(.*)/?$               $zproot$/index.php?p=news&date=$1 last;
    rewrite ^$zproot$/news/(.*)/?$                       $zproot$/index.php?p=news&title=$1 last;
}

# Root
location $zproot$/ {
    try_files $uri $uri/ @zenphoto;
}

location ~* $zproot$/cache/.*\.(?:ico|css|js|gif|jpe?g|png)$ {
    # Some basic cache-control for static files to be sent to the browser
    expires max;
    add_header Pragma public;
    add_header Cache-Control "public, must-revalidate, proxy-revalidate";
    log_not_found off;
}